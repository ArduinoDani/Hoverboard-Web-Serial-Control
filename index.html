<html>
  <body>
    <label for="baud">Baud:</label>
    <select id="baud">
        <option value="9600">9600</option>
        <option value="14400">14400</option>
        <option value="19200">19200</option>
        <option value="38400" selected="selected">38400</option>
        <option value="57600">57600</option>
        <option value="115200">115200</option>
    </select>

    <button id="portSelect" type="button" onclick="connect()">Select a port</button>
    <button id="disconnectButton" type="button" onclick="disconnect()">Disconnect</button>
    <input id="steer" placeholder="Steer">
    <input id="speed" placeholder="Speed">
    <button id="send" type="button" onclick="send()">Send</button>
    <button id="clear" class='form' type="button" onclick="clr()">Clear</button>
    <input class='form' id="ascroll" type="checkbox" checked><label for="ascroll">Autoscroll</label>
    <div id="log"></div>
  </body>

<script>
 var steer = document.getElementById('steer');
 var speed = document.getElementById('speed');
 var baud = document.getElementById('baud');
 var send_btn = document.getElementById('send');
 var logger = document.getElementById('log');
 var ascroll = document.getElementById('ascroll');
 

 var port;
 var reader;
 var writer;

var serial_frame = 0xABCD;

// Execute a function when the user releases a key on the keyboard
steer.addEventListener("keyup", function(event) {
  // Number 13 is the "Enter" key on the keyboard
  if (event.keyCode === 13) {
    // Cancel the default action, if needed
    event.preventDefault();
    // Trigger the button element with a click
    send_btn.click();
  }
});

// Execute a function when the user releases a key on the keyboard
speed.addEventListener("keyup", function(event) {
  // Number 13 is the "Enter" key on the keyboard
  if (event.keyCode === 13) {
    // Cancel the default action, if needed
    event.preventDefault();
    // Trigger the button element with a click
    send_btn.click();
  }
});

 const encoder = new TextEncoderStream();
 let decoder = new TextDecoderStream();

 const connect = async function () {

  if ("serial" in navigator) {
  // The Serial API is supported.

    port = await navigator.serial.requestPort();

    // Open and begin reading.
    await port.open({
      baudRate: baud.value
    });

    while (port.readable) {
      inputStream = port.readable;
      reader = inputStream.getReader();

      //inputDone = port.readable.pipeTo(decoder.writable);
      //inputStream = decoder.readable;
      //reader = inputStream.getReader();

      outputStream = port.writable;
      writer = outputStream.getWriter();

      while (true) {
        send();

        let value, done;
        try {
          ({ value, done } = await reader.read());
        } catch (error) {
          console.log("Error");
          break;
        }
        if (done) {
          console.log("Reader canceled");
          break;
        }

        //logger.innerHTML += value.replace(/\n/g, "<br />");
        //if (ascroll.checked) logger.scrollTop = logger.scrollHeight;
        
        var buf = new ArrayBuffer(value);
        var dv  = new DataView(buf);
        
        var buf = new ArrayBuffer(1000);
        var dv  = new DataView(buf);
        for (var i=0, strLen=value.length; i < strLen; i++) {       
             dv.setUint8(i,value[i],true);
        }
         
        frame = dv.getUint16(0,true);
        cmd1 = dv.getInt16(2,true);
        cmd2 = dv.getInt16(4,true);
        speedR = dv.getInt16(6,true);
        speedL = dv.getInt16(8,true);
        speedL = dv.getInt16(8,true);
        bat  = dv.getInt16(10,true);
        temp = dv.getInt16(12,true);
        checksum = dv.getUint16(14,true);

        if (frame == 0xABCD) {

           logger.innerHTML += "cmd1:" + cmd1.toString(10) + " " + 
                               "cmd2:" + cmd2.toString(10) + " " +
                               "speedR:" + speedR.toString(10) + " " +
                               "speedL:" + speedL.toString(10) + " " +
                               "bat:" + bat.toString(10) + " " +
                               "temp:" + temp.toString(10) + " " + 
                               "checksum:" + checksum.toString(10) + " " +
                               "<br />";
           if (ascroll.checked) logger.scrollTop = logger.scrollHeight;
        }

                
      }
      reader.releaseLock();
      }
    }
  };

  const send = async function () {
    var ab = new ArrayBuffer(8);
    var dv = new DataView(ab);
    
    dv.setUint16(0,serial_frame,true);
    dv.setInt16(2, parseInt(steer.value),true);
    dv.setInt16(4, parseInt(speed.value),true);
    dv.setUint16(6,serial_frame ^ parseInt(steer.value) ^ parseInt(speed.value),true);

    view = new Uint8Array(ab);
    await writer.write(view);
    
  };

  const clr = async function () {
    logger.innerHTML = "";
  };

const disconnect = async function () {
  writer.releaseLock();
  reader.releaseLock();
  await port.close();
};


</script>

<style>
  #log{
    height:90%;
    width:100%;
    overflow:auto;
    border-color: white;
    border-style:dashed;
  }

</style>


</html>
